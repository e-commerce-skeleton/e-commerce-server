# Documentación de Migraciones con Alembic en FastAPI

## ¿Qué es Alembic?

**Alembic** es una herramienta de migración de bases de datos para proyectos que utilizan **SQLAlchemy**. Las migraciones permiten realizar cambios controlados y estructurados en la base de datos a lo largo del tiempo, lo cual es esencial cuando los modelos de la base de datos cambian.

## ¿Qué es una migración?

Una **migración** es un conjunto de instrucciones que se utilizan para modificar la estructura de la base de datos, como:

- **Agregar nuevas tablas**.
- **Modificar tablas existentes** (agregar o quitar columnas).
- **Cambiar el tipo de datos de una columna**.
- **Eliminar tablas**.
- **Cambiar restricciones o relaciones** entre tablas.

## Uso de Alembic para realizar migraciones

### 1. Generar un sript de migracion 

Una vez que hayas realizado cambios en los modelos de SQLAlchemy, puedes pedirle a Alembic que genere automáticamente un script de migración.

Para generar una migración, utiliza el siguiente comando:

```bash
alembic revision --autogenerate -m "migration name"
```

Este comando compara los modelos definidos en tu código con la estructura actual de la base de datos y genera un archivo de migración en el directorio **alembic/versions/**.

### 2. Revisar

El archivo de migración generado se encuentra en el directorio **alembic/versions/**. Este archivo contiene un conjunto de instrucciones que describen los cambios que se deben aplicar a la base de datos. Al final de este archivo, pongo un ejemplo, para que el lector no se asuste y lea el paso 3 que es muy importante.

Por ejemplo, un archivo de migración podría verse como esto: 

- **upgrade()**: Define las instrucciones para aplicar los cambios a la base de datos.

- **downgrade()**: Define las instrucciones para revertir los cambios realizados.

Es importante revisar este archivo para asegurarte de que Alembic haya detectado correctamente todos los cambios en tus modelos.

### 3. Aplicar la migración

Una vez revisado el archivo de migración, puedes aplicar la migración a la base de datos con el siguiente comando:

```bash
alembic upgrade head
```

Este comando aplica todas las migraciones pendientes hasta la versión más reciente (head).

### 4. Deshacer una migración (si es necesario)

Si algo salió mal o necesitas deshacer una migración, puedes revertirla con el siguiente comando:

```bash
alembic downgrade -1
```

Esto deshará la última migración aplicada. También puedes usar -2, -3, etc., para deshacer varias migraciones.

## Beneficios de usar Alembic

- **Control de cambios**: Alembic te permite realizar un seguimiento de todos los cambios en la base de datos.

- **Facilidad de despliegue**: Cada miembro del equipo puede aplicar las migraciones en sus bases de datos locales para mantener la misma estructura de base de datos.

- **Revertir cambios**: Puedes deshacer migraciones si cometiste un error.

- **Automatización**: Puedes automatizar el proceso de aplicar migraciones en los despliegues de producción.

## Ejemplo de un archivo de migracion

```python
"""Create users table

Revision ID: ee41fa07f602
Revises: 
Create Date: 2025-03-23 12:12:38.073748

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'ee41fa07f602'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users',
    sa.Column('user_id', sa.String(), nullable=False),
    sa.Column('email', sa.String(), nullable=True),
    sa.Column('name', sa.String(), nullable=True),
    sa.PrimaryKeyConstraint('user_id')
    )
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)
    op.create_index(op.f('ix_users_name'), 'users', ['name'], unique=False)
    op.create_index(op.f('ix_users_user_id'), 'users', ['user_id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_users_user_id'), table_name='users')
    op.drop_index(op.f('ix_users_name'), table_name='users')
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.drop_table('users')
    # ### end Alembic commands ###
```
